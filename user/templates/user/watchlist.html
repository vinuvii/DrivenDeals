{% extends 'base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<style>
    .watchlist-item {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        display: flex;
        align-items: center;
    }
    .watchlist-item img {
        margin-right: 20px;
    }
    .watchlist-item-details {
        flex-grow: 1;
    }
    .remove-watchlist-button {
        color: red;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<h1>My Watchlist</h1>

{% if watchlist_items %}
    <ul id="watchlist">
        {% for item in watchlist_items %}
            <li class="watchlist-item" id="watchlist-item-{{ item.vehicle.id }}">
                {% if item.vehicle.picture %}
                    <img src="{{ item.vehicle.picture.url }}" alt="Vehicle Image" width="100">
                {% endif %}
                <div class="watchlist-item-details">
                    <strong>{{ item.vehicle.make }} {{ item.vehicle.model }} ({{ item.vehicle.year }})</strong><br>
                    Price: {{ item.vehicle.price }}<br>
                    Mileage: {{ item.vehicle.mileage }} km<br>
                    Color: {{ item.vehicle.color }}<br>
                    <a href="{% url 'vehicle_detail' item.vehicle.id %}">View Details</a>
                </div>
                <div>
                    <i class="fas fa-trash-alt remove-watchlist-button" data-vehicle-id="{{ item.vehicle.id }}"></i>
                </div>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>You have no items in your watchlist.</p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const removeButtons = document.querySelectorAll('.remove-watchlist-button');

    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const vehicleId = this.dataset.vehicleId;
            const listItem = document.getElementById(`watchlist-item-${vehicleId}`);

            fetch(`{% url 'remove_from_watchlist' vehicle_id=0 %}`.replace('0', vehicleId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ vehicle_id: vehicleId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.removed) {
                    // Remove the list item from the DOM
                    listItem.remove();
                    // Optionally, refresh the page or handle any UI updates
                    // You can add further logic here if needed
                    location.reload(); // This line refreshes the entire page
                } else {
                    console.error('Failed to remove item from watchlist:', data.error);
                    // Handle error case if removal fails
                }
            })
            .catch(error => {
                console.error('Error removing item from watchlist:', error);
            });
        });
    });
});
</script>

{% endblock %}


